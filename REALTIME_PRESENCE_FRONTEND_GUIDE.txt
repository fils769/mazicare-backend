================================================================================
REAL-TIME USER PRESENCE - FRONTEND INTEGRATION GUIDE
================================================================================

This guide shows you how to use the real-time user presence system in your
frontend application (React, Vue, Angular, or vanilla JavaScript).

================================================================================
TABLE OF CONTENTS
================================================================================

1. Setup & Installation
2. Basic Usage Examples
3. React Integration (Hooks & Components)
4. Vue Integration
5. Angular Integration
6. Vanilla JavaScript
7. Complete Examples
8. Best Practices
9. Troubleshooting

================================================================================
1. SETUP & INSTALLATION
================================================================================

First, install socket.io-client:

npm install socket.io-client
# or
yarn add socket.io-client

================================================================================
2. BASIC USAGE EXAMPLES
================================================================================

--- Create Socket Connection ---

// socket.ts or socket.js
import { io } from 'socket.io-client';

const SOCKET_URL = 'http://localhost:3000'; // Your backend URL
const token = localStorage.getItem('token'); // Your JWT token

export const socket = io(`${SOCKET_URL}/ws/messages`, {
  auth: { token },
  transports: ['websocket', 'polling'],
  reconnection: true,
  reconnectionAttempts: 5,
  reconnectionDelay: 1000,
});

// Listen for connection events
socket.on('connect', () => {
  console.log('âœ… Connected to WebSocket');
});

socket.on('disconnect', () => {
  console.log('âŒ Disconnected from WebSocket');
});

socket.on('error', (error) => {
  console.error('WebSocket error:', error);
});

--- Check if a User is Online ---

socket.emit('check-user-status', { userId: 'user-123' }, (response) => {
  console.log('User status:', response.data);
  // response.data = {
  //   userId: 'user-123',
  //   online: true,
  //   lastActive: '2026-01-04T00:00:00.000Z',
  //   connectedAt: '2026-01-03T23:55:00.000Z',
  //   timestamp: '2026-01-04T00:00:00.000Z'
  // }
});

--- Check Multiple Users at Once ---

socket.emit('check-users-status', { 
  userIds: ['user-1', 'user-2', 'user-3'] 
}, (response) => {
  console.log('Users status:', response.data.statuses);
  // response.data.statuses = [
  //   { userId: 'user-1', online: true, ... },
  //   { userId: 'user-2', online: false, ... },
  //   { userId: 'user-3', online: true, ... }
  // ]
});

--- Get All Online Users ---

socket.emit('get-online-users', {}, (response) => {
  console.log('Online users:', response.data.users);
  console.log('Total online:', response.data.count);
});

--- Listen for User Online/Offline Events ---

socket.on('user-online', (data) => {
  console.log(`User ${data.userId} is now online`);
  // Update your UI to show user is online
});

socket.on('user-offline', (data) => {
  console.log(`User ${data.userId} is now offline`);
  // Update your UI to show user is offline
});

--- Send Heartbeat (Keep Connection Alive) ---

// Send heartbeat every 30 seconds
setInterval(() => {
  if (socket.connected) {
    socket.emit('heartbeat', {}, (response) => {
      console.log('Heartbeat sent:', response.data.timestamp);
    });
  }
}, 30000);

================================================================================
3. REACT INTEGRATION (HOOKS & COMPONENTS)
================================================================================

--- Custom Hook: useUserPresence ---

// hooks/useUserPresence.ts
import { useEffect, useState } from 'react';
import { socket } from '../socket';

interface UserStatus {
  userId: string;
  online: boolean;
  lastActive?: string;
  connectedAt?: string;
}

export function useUserPresence(userId: string) {
  const [status, setStatus] = useState<UserStatus>({
    userId,
    online: false
  });
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!userId) return;

    // Check initial status
    socket.emit('check-user-status', { userId }, (response) => {
      setStatus(response.data);
      setLoading(false);
    });

    // Listen for online/offline events
    const handleUserOnline = (data: any) => {
      if (data.userId === userId) {
        setStatus(prev => ({ 
          ...prev, 
          online: true,
          connectedAt: data.timestamp 
        }));
      }
    };

    const handleUserOffline = (data: any) => {
      if (data.userId === userId) {
        setStatus(prev => ({ 
          ...prev, 
          online: false 
        }));
      }
    };

    socket.on('user-online', handleUserOnline);
    socket.on('user-offline', handleUserOffline);

    return () => {
      socket.off('user-online', handleUserOnline);
      socket.off('user-offline', handleUserOffline);
    };
  }, [userId]);

  return { ...status, loading };
}

--- Custom Hook: useOnlineUsers ---

// hooks/useOnlineUsers.ts
import { useEffect, useState } from 'react';
import { socket } from '../socket';

interface OnlineUser {
  userId: string;
  email?: string;
  role?: string;
  connectedAt?: string;
  lastActive?: string;
}

export function useOnlineUsers() {
  const [users, setUsers] = useState<OnlineUser[]>([]);
  const [count, setCount] = useState(0);
  const [loading, setLoading] = useState(true);

  const refreshOnlineUsers = () => {
    socket.emit('get-online-users', {}, (response) => {
      setUsers(response.data.users);
      setCount(response.data.count);
      setLoading(false);
    });
  };

  useEffect(() => {
    // Get initial list
    refreshOnlineUsers();

    // Update list when users go online/offline
    socket.on('user-online', refreshOnlineUsers);
    socket.on('user-offline', refreshOnlineUsers);

    // Refresh on reconnect
    socket.on('connect', refreshOnlineUsers);

    return () => {
      socket.off('user-online', refreshOnlineUsers);
      socket.off('user-offline', refreshOnlineUsers);
      socket.off('connect', refreshOnlineUsers);
    };
  }, []);

  return { users, count, loading, refresh: refreshOnlineUsers };
}

--- Component: OnlineIndicator ---

// components/OnlineIndicator.tsx
import React from 'react';
import { useUserPresence } from '../hooks/useUserPresence';

interface Props {
  userId: string;
  showText?: boolean;
}

export function OnlineIndicator({ userId, showText = true }: Props) {
  const { online, loading } = useUserPresence(userId);

  if (loading) {
    return <span className="text-gray-400">...</span>;
  }

  return (
    <div className="flex items-center gap-2">
      <span 
        className={`inline-block w-3 h-3 rounded-full ${
          online ? 'bg-green-500' : 'bg-gray-400'
        }`}
      />
      {showText && (
        <span className={online ? 'text-green-600' : 'text-gray-500'}>
          {online ? 'Online' : 'Offline'}
        </span>
      )}
    </div>
  );
}

--- Component: UserCard with Online Status ---

// components/UserCard.tsx
import React from 'react';
import { useUserPresence } from '../hooks/useUserPresence';

interface Props {
  userId: string;
  name: string;
  email: string;
  avatar?: string;
}

export function UserCard({ userId, name, email, avatar }: Props) {
  const { online, lastActive } = useUserPresence(userId);

  return (
    <div className="border rounded-lg p-4 shadow-sm">
      <div className="flex items-start gap-3">
        <div className="relative">
          <img 
            src={avatar || '/default-avatar.png'} 
            alt={name}
            className="w-12 h-12 rounded-full"
          />
          {/* Online indicator dot */}
          <span 
            className={`absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white ${
              online ? 'bg-green-500' : 'bg-gray-400'
            }`}
          />
        </div>
        
        <div className="flex-1">
          <h3 className="font-semibold">{name}</h3>
          <p className="text-sm text-gray-600">{email}</p>
          
          <div className="mt-2 text-xs">
            {online ? (
              <span className="text-green-600 font-medium">ðŸŸ¢ Online now</span>
            ) : lastActive ? (
              <span className="text-gray-500">
                Last seen: {new Date(lastActive).toLocaleString()}
              </span>
            ) : (
              <span className="text-gray-500">Offline</span>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

--- Component: OnlineUsersList ---

// components/OnlineUsersList.tsx
import React from 'react';
import { useOnlineUsers } from '../hooks/useOnlineUsers';

export function OnlineUsersList() {
  const { users, count, loading, refresh } = useOnlineUsers();

  if (loading) {
    return <div>Loading online users...</div>;
  }

  return (
    <div className="bg-white rounded-lg shadow p-4">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-bold">
          Online Users ({count})
        </h2>
        <button 
          onClick={refresh}
          className="text-sm text-blue-600 hover:text-blue-800"
        >
          Refresh
        </button>
      </div>

      {users.length === 0 ? (
        <p className="text-gray-500">No users online</p>
      ) : (
        <ul className="space-y-2">
          {users.map(user => (
            <li 
              key={user.userId}
              className="flex items-center gap-3 p-2 hover:bg-gray-50 rounded"
            >
              <span className="w-2 h-2 bg-green-500 rounded-full" />
              <div className="flex-1">
                <div className="font-medium">{user.email}</div>
                <div className="text-xs text-gray-500">{user.role}</div>
              </div>
              <div className="text-xs text-gray-400">
                {user.connectedAt && 
                  new Date(user.connectedAt).toLocaleTimeString()
                }
              </div>
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}

--- Component: Chat with Online Status ---

// components/ChatSidebar.tsx
import React from 'react';
import { useUserPresence } from '../hooks/useUserPresence';

interface Conversation {
  id: string;
  otherUserId: string;
  otherUserName: string;
  lastMessage: string;
}

interface Props {
  conversations: Conversation[];
  onSelectConversation: (id: string) => void;
}

export function ChatSidebar({ conversations, onSelectConversation }: Props) {
  return (
    <div className="w-64 bg-white border-r">
      <h2 className="p-4 font-bold text-lg">Messages</h2>
      <div className="overflow-y-auto">
        {conversations.map(conv => (
          <ConversationItem
            key={conv.id}
            conversation={conv}
            onClick={() => onSelectConversation(conv.id)}
          />
        ))}
      </div>
    </div>
  );
}

function ConversationItem({ 
  conversation, 
  onClick 
}: { 
  conversation: Conversation; 
  onClick: () => void;
}) {
  const { online } = useUserPresence(conversation.otherUserId);

  return (
    <div 
      onClick={onClick}
      className="p-4 hover:bg-gray-50 cursor-pointer border-b"
    >
      <div className="flex items-center gap-3">
        <div className="relative">
          <div className="w-10 h-10 bg-gray-300 rounded-full" />
          {online && (
            <span className="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white" />
          )}
        </div>
        <div className="flex-1 min-w-0">
          <div className="font-medium truncate">
            {conversation.otherUserName}
          </div>
          <div className="text-sm text-gray-500 truncate">
            {conversation.lastMessage}
          </div>
        </div>
      </div>
    </div>
  );
}

================================================================================
4. VUE INTEGRATION
================================================================================

--- Composable: useUserPresence ---

// composables/useUserPresence.ts
import { ref, onMounted, onUnmounted } from 'vue';
import { socket } from '../socket';

export function useUserPresence(userId: string) {
  const online = ref(false);
  const lastActive = ref<string | undefined>();
  const connectedAt = ref<string | undefined>();
  const loading = ref(true);

  const checkStatus = () => {
    socket.emit('check-user-status', { userId }, (response) => {
      online.value = response.data.online;
      lastActive.value = response.data.lastActive;
      connectedAt.value = response.data.connectedAt;
      loading.value = false;
    });
  };

  const handleUserOnline = (data: any) => {
    if (data.userId === userId) {
      online.value = true;
      connectedAt.value = data.timestamp;
    }
  };

  const handleUserOffline = (data: any) => {
    if (data.userId === userId) {
      online.value = false;
    }
  };

  onMounted(() => {
    checkStatus();
    socket.on('user-online', handleUserOnline);
    socket.on('user-offline', handleUserOffline);
  });

  onUnmounted(() => {
    socket.off('user-online', handleUserOnline);
    socket.off('user-offline', handleUserOffline);
  });

  return { online, lastActive, connectedAt, loading };
}

--- Component: OnlineIndicator.vue ---

<template>
  <div class="flex items-center gap-2">
    <span 
      :class="[
        'inline-block w-3 h-3 rounded-full',
        online ? 'bg-green-500' : 'bg-gray-400'
      ]"
    />
    <span v-if="showText" :class="online ? 'text-green-600' : 'text-gray-500'">
      {{ online ? 'Online' : 'Offline' }}
    </span>
  </div>
</template>

<script setup lang="ts">
import { useUserPresence } from '../composables/useUserPresence';

const props = defineProps<{
  userId: string;
  showText?: boolean;
}>();

const { online } = useUserPresence(props.userId);
</script>

================================================================================
5. ANGULAR INTEGRATION
================================================================================

--- Service: PresenceService ---

// services/presence.service.ts
import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';
import { socket } from '../socket';

interface UserStatus {
  userId: string;
  online: boolean;
  lastActive?: string;
  connectedAt?: string;
}

@Injectable({
  providedIn: 'root'
})
export class PresenceService {
  private userStatuses = new Map<string, BehaviorSubject<UserStatus>>();

  constructor() {
    // Listen for global online/offline events
    socket.on('user-online', (data) => {
      this.updateUserStatus(data.userId, true);
    });

    socket.on('user-offline', (data) => {
      this.updateUserStatus(data.userId, false);
    });
  }

  getUserStatus(userId: string): Observable<UserStatus> {
    if (!this.userStatuses.has(userId)) {
      const subject = new BehaviorSubject<UserStatus>({
        userId,
        online: false
      });
      this.userStatuses.set(userId, subject);
      this.checkUserStatus(userId);
    }
    return this.userStatuses.get(userId)!.asObservable();
  }

  private checkUserStatus(userId: string): void {
    socket.emit('check-user-status', { userId }, (response) => {
      const subject = this.userStatuses.get(userId);
      if (subject) {
        subject.next(response.data);
      }
    });
  }

  private updateUserStatus(userId: string, online: boolean): void {
    const subject = this.userStatuses.get(userId);
    if (subject) {
      subject.next({
        ...subject.value,
        online
      });
    }
  }
}

--- Component: online-indicator.component.ts ---

import { Component, Input, OnInit } from '@angular/core';
import { Observable } from 'rxjs';
import { PresenceService } from '../services/presence.service';

@Component({
  selector: 'app-online-indicator',
  template: `
    <div class="flex items-center gap-2">
      <span 
        [class]="(status$ | async)?.online ? 'bg-green-500' : 'bg-gray-400'"
        class="inline-block w-3 h-3 rounded-full"
      ></span>
      <span *ngIf="showText">
        {{ (status$ | async)?.online ? 'Online' : 'Offline' }}
      </span>
    </div>
  `
})
export class OnlineIndicatorComponent implements OnInit {
  @Input() userId!: string;
  @Input() showText = true;
  
  status$!: Observable<any>;

  constructor(private presenceService: PresenceService) {}

  ngOnInit() {
    this.status$ = this.presenceService.getUserStatus(this.userId);
  }
}

================================================================================
6. VANILLA JAVASCRIPT
================================================================================

--- Complete Example ---

<!DOCTYPE html>
<html>
<head>
  <title>User Presence Demo</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    .online { color: green; }
    .offline { color: gray; }
    .dot { 
      display: inline-block; 
      width: 10px; 
      height: 10px; 
      border-radius: 50%; 
      margin-right: 5px;
    }
    .dot.online { background: green; }
    .dot.offline { background: gray; }
  </style>
</head>
<body>
  <h1>User Presence Demo</h1>
  
  <div>
    <h2>Check User Status</h2>
    <input type="text" id="userId" placeholder="Enter user ID">
    <button onclick="checkUserStatus()">Check Status</button>
    <div id="userStatus"></div>
  </div>

  <div>
    <h2>Online Users</h2>
    <button onclick="getOnlineUsers()">Refresh</button>
    <div id="onlineUsers"></div>
  </div>

  <script>
    // Connect to WebSocket
    const token = localStorage.getItem('token');
    const socket = io('http://localhost:3000/ws/messages', {
      auth: { token }
    });

    socket.on('connect', () => {
      console.log('Connected to WebSocket');
      document.body.style.borderTop = '3px solid green';
    });

    socket.on('disconnect', () => {
      console.log('Disconnected from WebSocket');
      document.body.style.borderTop = '3px solid red';
    });

    // Listen for user online/offline events
    socket.on('user-online', (data) => {
      console.log('User online:', data);
      showNotification(`User ${data.userId} is now online`);
      getOnlineUsers(); // Refresh list
    });

    socket.on('user-offline', (data) => {
      console.log('User offline:', data);
      showNotification(`User ${data.userId} is now offline`);
      getOnlineUsers(); // Refresh list
    });

    // Check user status
    function checkUserStatus() {
      const userId = document.getElementById('userId').value;
      if (!userId) return alert('Please enter a user ID');

      socket.emit('check-user-status', { userId }, (response) => {
        const status = response.data;
        const html = `
          <div class="${status.online ? 'online' : 'offline'}">
            <span class="dot ${status.online ? 'online' : 'offline'}"></span>
            User ${status.userId} is ${status.online ? 'ONLINE' : 'OFFLINE'}
            ${status.lastActive ? `<br>Last active: ${new Date(status.lastActive).toLocaleString()}` : ''}
          </div>
        `;
        document.getElementById('userStatus').innerHTML = html;
      });
    }

    // Get all online users
    function getOnlineUsers() {
      socket.emit('get-online-users', {}, (response) => {
        const users = response.data.users;
        const count = response.data.count;
        
        let html = `<p><strong>${count} users online</strong></p><ul>`;
        users.forEach(user => {
          html += `
            <li>
              <span class="dot online"></span>
              ${user.email || user.userId} (${user.role})
              <small>Connected: ${new Date(user.connectedAt).toLocaleTimeString()}</small>
            </li>
          `;
        });
        html += '</ul>';
        
        document.getElementById('onlineUsers').innerHTML = html;
      });
    }

    // Show notification
    function showNotification(message) {
      const div = document.createElement('div');
      div.textContent = message;
      div.style.cssText = 'position:fixed;top:20px;right:20px;background:#333;color:white;padding:10px;border-radius:5px;';
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    // Send heartbeat every 30 seconds
    setInterval(() => {
      if (socket.connected) {
        socket.emit('heartbeat');
      }
    }, 30000);

    // Load online users on page load
    socket.on('connect', getOnlineUsers);
  </script>
</body>
</html>

================================================================================
7. COMPLETE EXAMPLE: CHAT APPLICATION WITH PRESENCE
================================================================================

--- React Chat App with Online Status ---

// App.tsx
import React, { useEffect, useState } from 'react';
import { socket } from './socket';
import { ChatSidebar } from './components/ChatSidebar';
import { ChatWindow } from './components/ChatWindow';
import { OnlineUsersList } from './components/OnlineUsersList';

export function App() {
  const [connected, setConnected] = useState(false);
  const [selectedConversation, setSelectedConversation] = useState<string | null>(null);

  useEffect(() => {
    socket.on('connect', () => setConnected(true));
    socket.on('disconnect', () => setConnected(false));

    // Send heartbeat every 30 seconds
    const heartbeat = setInterval(() => {
      if (socket.connected) {
        socket.emit('heartbeat');
      }
    }, 30000);

    return () => {
      clearInterval(heartbeat);
    };
  }, []);

  return (
    <div className="flex h-screen">
      {/* Connection Status */}
      <div className={`fixed top-0 left-0 right-0 p-2 text-center text-white ${
        connected ? 'bg-green-500' : 'bg-red-500'
      }`}>
        {connected ? 'ðŸŸ¢ Connected' : 'ðŸ”´ Disconnected'}
      </div>

      {/* Sidebar */}
      <div className="w-64 bg-gray-100 mt-10">
        <OnlineUsersList />
      </div>

      {/* Chat Area */}
      <div className="flex-1 flex flex-col mt-10">
        <ChatSidebar 
          onSelectConversation={setSelectedConversation}
        />
        {selectedConversation && (
          <ChatWindow conversationId={selectedConversation} />
        )}
      </div>
    </div>
  );
}

================================================================================
8. BEST PRACTICES
================================================================================

1. HEARTBEAT IMPLEMENTATION
   - Send heartbeat every 30 seconds to keep connection alive
   - Update user's last active timestamp
   - Example:
     setInterval(() => {
       if (socket.connected) socket.emit('heartbeat');
     }, 30000);

2. BATCH STATUS CHECKS
   - Use 'check-users-status' for multiple users instead of individual calls
   - More efficient and reduces server load
   - Example:
     socket.emit('check-users-status', { userIds: ['user1', 'user2', 'user3'] });

3. DEBOUNCE UI UPDATES
   - Prevent excessive re-renders from rapid status changes
   - Use debounce/throttle for presence updates
   - Example with lodash:
     const updatePresence = debounce((data) => setStatus(data), 500);

4. HANDLE RECONNECTION
   - Refresh presence data when socket reconnects
   - Example:
     socket.on('connect', () => {
       socket.emit('get-online-users', {}, (response) => {
         setOnlineUsers(response.data.users);
       });
     });

5. CLEANUP LISTENERS
   - Always remove event listeners in cleanup functions
   - Prevents memory leaks
   - Example (React):
     useEffect(() => {
       socket.on('user-online', handler);
       return () => socket.off('user-online', handler);
     }, []);

6. ERROR HANDLING
   - Listen for error events
   - Show user-friendly messages
   - Example:
     socket.on('error', (error) => {
       console.error('WebSocket error:', error);
       toast.error('Connection error. Please refresh.');
     });

7. LOADING STATES
   - Show loading indicators while fetching presence data
   - Improves user experience
   - Example:
     const [loading, setLoading] = useState(true);
     socket.emit('check-user-status', { userId }, (response) => {
       setStatus(response.data);
       setLoading(false);
     });

8. OPTIMIZE RE-RENDERS
   - Use React.memo for components that display presence
   - Only re-render when status actually changes
   - Example:
     export const OnlineIndicator = React.memo(({ userId }) => {
       const { online } = useUserPresence(userId);
       return <span>{online ? 'ðŸŸ¢' : 'âš«'}</span>;
     });

================================================================================
9. TROUBLESHOOTING
================================================================================

PROBLEM: Socket not connecting
SOLUTION:
  - Check if backend is running
  - Verify WebSocket URL is correct
  - Ensure JWT token is valid
  - Check CORS settings in backend
  - Open browser console for error messages

PROBLEM: User status not updating
SOLUTION:
  - Verify event listeners are properly attached
  - Check if socket is connected (socket.connected)
  - Ensure userId is correct
  - Look for errors in browser console
  - Try refreshing the page

PROBLEM: Memory leaks
SOLUTION:
  - Always remove event listeners in cleanup
  - Use useEffect cleanup in React
  - Don't create multiple socket instances
  - Clear intervals/timeouts on unmount

PROBLEM: Status shows offline but user is online
SOLUTION:
  - Check if heartbeat is being sent
  - Verify socket connection is stable
  - Refresh online users list
  - Check server logs for disconnection events

PROBLEM: Too many re-renders
SOLUTION:
  - Use debounce for status updates
  - Implement React.memo for components
  - Use useMemo/useCallback for expensive operations
  - Check for infinite loops in useEffect

================================================================================
QUICK REFERENCE
================================================================================

EVENTS TO EMIT:
  - check-user-status        Check if one user is online
  - check-users-status       Check multiple users at once
  - get-online-users         Get all online users
  - heartbeat                Send keep-alive signal

EVENTS TO LISTEN:
  - user-online              User came online
  - user-offline             User went offline
  - connected                You connected successfully
  - disconnect               You disconnected
  - error                    Error occurred

RESPONSE FORMAT:
  All responses have this structure:
  {
    event: 'event-name',
    data: { ... }
  }

================================================================================
SUPPORT
================================================================================

For more information, check:
  - Backend implementation: src/messages/messages.gateway.ts
  - WebSocket documentation: https://socket.io/docs/v4/
  - NestJS WebSocket: https://docs.nestjs.com/websockets/gateways

Questions? Check the main documentation or contact the development team.

================================================================================
