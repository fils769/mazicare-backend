generator client {
  provider = "prisma-client-js"
}

model DealClaim {
  id        String   @id @default(cuid())
  dealId    String
  userId    String
  createdAt DateTime @default(now())

  deal Deal @relation(fields: [dealId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([dealId, userId])
  @@map("deal_claims")
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL") // Only needed for Neon/serverless
}

model User {
  id             String        @id @default(cuid())
  email          String        @unique
  password       String?
  role           UserRole
  status         AccountStatus @default(PENDING)
  isVerified     Boolean       @default(false)
  phoneNumber    String?       @unique
  phoneVerified  Boolean       @default(false)
  profilePicture String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  otps                Otp[]
  caregiver           Caregiver?
  family              Family?
  eventRegistrations  EventRegistration[]
  sentMessages        Message[]            @relation("SentMessages")
  receivedMessages    Message[]            @relation("ReceivedMessages")
  notifications       Notification[]       @relation("UserNotifications")
  subscription        Subscription?        @relation("UserSubscription")
  reviews             Review[]             @relation("UserReviews")
  activityLogs        ActivityLog[]
  dealClaims          DealClaim[]
  paymentTransactions PaymentTransaction[]
  supportTickets      SupportTicket[]

  @@map("users")
}

model Otp {
  id          String   @id @default(cuid())
  email       String?
  phoneNumber String?
  identifier  String
  otp         String
  type        OtpType
  expiresAt   DateTime
  used        Boolean  @default(false)
  createdAt   DateTime @default(now())

  user User? @relation(fields: [email], references: [email])

  @@map("otps")
}

enum UserRole {
  ADMIN
  CAREGIVER
  FAMILY
}

enum AccountStatus {
  PENDING
  ACTIVE
  FREEZE
  REJECTED
}

enum OtpType {
  VERIFICATION
  PASSWORD_RESET
  SIGNUP
}

model Caregiver {
  id                   String        @id @default(cuid())
  userId               String        @unique
  firstName            String?
  lastName             String?
  dateOfBirth          String?
  gender               String?
  region               String?
  bio                  String?
  profilePicture       String?
  email                String?
  phone                String?
  regionId             String?
  programs             CareProgram[]
  documentUrl          String?
  idPassportPhoto      String?
  recommendationLetter String?
  certificates         String[]
  experience           Int?
  onboardingComplete   Boolean       @default(false)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  stripeAccountId      String?
  languages            String[]

  user            User    @relation(fields: [userId], references: [id])
  caregiverRegion Region? @relation(fields: [regionId], references: [id])

  reviews             Review[]             @relation("CaregiverReviews")
  paymentTransactions PaymentTransaction[]
  careRequests        CareRequest[]

  @@map("caregivers")
}

model CareProgram {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())

  caregivers Caregiver[]
  elders     Elder[]

  @@map("care_programs")
}

model Family {
  id                 String   @id @default(cuid())
  userId             String   @unique
  familyName         String?
  careFor            String?
  ageGroup           String?
  region             String?
  language           String?
  profilePicture     String?
  phone              String?
  careTypes          String[]
  schedule           String?
  daysHours          String?
  genderPreference   String?
  experienceLevel    String?
  backgroundCheck    Boolean  @default(false)
  onboardingComplete Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id])
  elders       Elder[]
  careRequests CareRequest[]

  @@map("families")
}

model Region {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())

  caregivers Caregiver[]

  @@map("regions")
}

model Language {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())

  @@map("languages")
}

model Elder {
  id             String   @id @default(cuid())
  familyId       String
  firstName      String
  lastName       String
  dateOfBirth    DateTime
  gender         Gender
  programId      String?
  description    String?
  profilePicture String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  family       Family        @relation(fields: [familyId], references: [id])
  program      CareProgram?  @relation(fields: [programId], references: [id])
  schedules    Schedule[]
  careRequests CareRequest[]

  @@map("elders")
}

enum CareType {
  FULL_TIME
  PART_TIME
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model CareRequest {
  id          String @id @default(cuid())
  elderId     String
  caregiverId String
  familyId    String

  careType CareType
  careDays DayOfWeek[]
  status   RequestStatus @default(PENDING)

  requestedAt DateTime  @default(now())
  respondedAt DateTime?
  expiresAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  elder     Elder      @relation(fields: [elderId], references: [id], onDelete: Cascade)
  caregiver Caregiver  @relation(fields: [caregiverId], references: [id])
  family    Family     @relation(fields: [familyId], references: [id])
  schedules Schedule[] @relation("CareRequestSchedules")

  @@index([elderId, status])
  @@index([elderId], name: "elderId_index")
  @@index([caregiverId, status])
  @@index([caregiverId])
  @@index([familyId, status])
  @@index([familyId])
  @@index([status])
  @@index([elderId, caregiverId, status])
  @@map("care_requests")
}

enum RequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
  EXPIRED
  COMPLETED
}

model Event {
  id              String    @id @default(cuid())
  title           String
  description     String?
  date            DateTime
  region          String?
  category        String?
  price           Float     @default(0)
  maxCapacity     Int?
  schedule        String?
  venue           String?
  venueUrl        String?
  categoryColor   String?
  subCategories   String?
  targetAges      String?
  specialFeatures String?
  eventUrl        String?
  imageUrl        String?
  imageWidth      Int?
  imageHeight     Int?
  imageSrcset     String?
  postId          String?
  scrapedAt       DateTime?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  registrations EventRegistration[]

  @@map("events")
}

model EventRegistration {
  id        String   @id @default(cuid())
  userId    String
  eventId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  event Event @relation(fields: [eventId], references: [id])

  @@unique([userId, eventId])
  @@map("event_registrations")
}

model Conversation {
  id              String    @id @default(cuid())
  participants    String[]
  lastMessage     String?
  lastMessageTime DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  messages Message[]

  @@map("conversations")
}

model Message {
  id             String    @id @default(cuid())
  conversationId String
  senderId       String
  recipientId    String
  content        String
  isRead         Boolean   @default(false)
  readAt         DateTime?
  createdAt      DateTime  @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id])
  sender       User         @relation("SentMessages", fields: [senderId], references: [id])
  recipient    User         @relation("ReceivedMessages", fields: [recipientId], references: [id])

  @@map("messages")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation("UserNotifications", fields: [userId], references: [id])

  @@map("notifications")
}

model Schedule {
  id            String    @id @default(cuid())
  elderId       String
  careRequestId String
  day           DayOfWeek
  start         String
  end           String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  elder         Elder          @relation(fields: [elderId], references: [id], onDelete: Cascade)
  careRequest   CareRequest    @relation("CareRequestSchedules", fields: [careRequestId], references: [id], onDelete: Cascade)
  scheduleItems ScheduleItem[]

  @@index([elderId])
  @@index([careRequestId])
  @@map("schedules")
}

model ScheduleItem {
  id          String         @id @default(cuid())
  scheduleId  String
  title       String
  description String?
  startTime   String // format "HH:MM"
  endTime     String // format "HH:MM"
  status      ScheduleStatus @default(PENDING)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  schedule Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@unique([scheduleId, startTime], name: "schedule_start_unique")
  @@index([scheduleId])
  @@map("schedule_items")
}

model Subscription {
  id        String             @id @default(cuid())
  userId    String             @unique
  planId    String
  status    SubscriptionStatus @default(ACTIVE)
  startDate DateTime           @default(now())
  endDate   DateTime
  price     Float
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  user User             @relation("UserSubscription", fields: [userId], references: [id])
  plan SubscriptionPlan @relation(fields: [planId], references: [id])

  @@map("subscriptions")
}

model SubscriptionPlan {
  id            String   @id @default(cuid())
  name          String   @unique
  price         Float
  features      String[]
  duration      String
  stripePriceId String?
  createdAt     DateTime @default(now())

  subscriptions Subscription[]

  @@map("subscription_plans")
}

enum PaymentType {
  SUBSCRIPTION
  CAREGIVER_PAYOUT
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

model Deal {
  id              String    @id @default(cuid())
  title           String
  description     String?
  category        String?
  discountPercent Float?
  price           Float?
  imageUrl        String?
  redirectUrl     String?
  region          String?
  startsAt        DateTime?
  endsAt          DateTime?
  createdBy       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  claims DealClaim[]

  @@map("deals")
}

model PaymentTransaction {
  id                      String        @id @default(cuid())
  userId                  String?
  caregiverId             String?
  amount                  Float
  currency                String        @default("usd")
  type                    PaymentType
  status                  PaymentStatus @default(PENDING)
  stripePaymentIntentId   String?
  stripeCheckoutSessionId String?
  stripeTransferId        String?
  metadata                Json?
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt

  user      User?      @relation(fields: [userId], references: [id])
  caregiver Caregiver? @relation(fields: [caregiverId], references: [id])

  @@index([userId])
  @@index([caregiverId])
  @@map("payment_transactions")
}

enum ActivityCategory {
  USER_ACTIVITY
  FEATURE_USAGE
  SYSTEM
}

model ActivityLog {
  id         String           @id @default(cuid())
  userId     String?
  actorRole  UserRole?
  category   ActivityCategory
  eventType  String
  entityType String?
  entityId   String?
  metadata   Json?
  createdAt  DateTime         @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

model Review {
  id          String   @id @default(cuid())
  caregiverId String
  reviewerId  String
  rating      Int
  comment     String?
  createdAt   DateTime @default(now())

  caregiver Caregiver @relation("CaregiverReviews", fields: [caregiverId], references: [id])
  reviewer  User      @relation("UserReviews", fields: [reviewerId], references: [id])

  @@map("reviews")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ScheduleStatus {
  PENDING
  COMPLETED
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

model SupportTicket {
  id          String         @id @default(cuid())
  userId      String
  subject     String
  description String
  category    String?
  priority    TicketPriority @default(MEDIUM)
  status      TicketStatus   @default(PENDING)
  adminNotes  String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  resolvedAt  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("support_tickets")
}

enum TicketStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Article {
  id        String         @id @default(cuid())
  title     String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  blocks    ContentBlock[]

  @@map("articles")
}

model ContentBlock {
  id        String         @id @default(cuid())
  type      String // 'heading', 'subheading', 'paragraph', 'image', 'list', 'layout'
  order     Int
  data      Json // Flexible JSON data for different block types
  articleId String
  article   Article        @relation(fields: [articleId], references: [id], onDelete: Cascade)
  parentId  String? // For layout children
  parent    ContentBlock?  @relation("BlockChildren", fields: [parentId], references: [id], onDelete: Cascade)
  children  ContentBlock[] @relation("BlockChildren")

  @@map("content_blocks")
}
